<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Submissions (CRUD)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>.container { margin-top: 50px; }</style>
</head>
<body>
    <div class="container">
        <h2>View Submissions (Read/Update/Delete)</h2>
        <a href="index.html" class="btn btn-secondary mb-3">Back to Create Form</a>

        <div class="row mb-3">
            <div class="col-md-6">
                <input type="email" class="form-control" id="searchEmail" placeholder="Search by Email (optional)">
            </div>
            <div class="col-md-6">
                <button id="fetchButton" class="btn btn-info">Fetch Submissions</button>
            </div>
        </div>

        <div id="statusMessage" class="alert d-none" role="alert"></div>
        
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID (PK)</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="submissionsTableBody">
                <tr><td colspan="5" class="text-center">Click 'Fetch Submissions' to load data.</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const API_BASE_URL = 'YOUR_API_GATEWAY_URL/prod'; 
        const API_READ_URL = `${API_BASE_URL}/submissions`;

        document.getElementById('fetchButton').addEventListener('click', async () => {
            const email = document.getElementById('searchEmail').value.trim();
            let url = API_READ_URL;
            if (email) url += `?email=${encodeURIComponent(email)}`;

            const tableBody = document.getElementById('submissionsTableBody');
            const statusDiv = document.getElementById('statusMessage');
            tableBody.innerHTML = '';
            statusDiv.classList.add('d-none');

            try {
                const response = await fetch(url);
                const submissions = await response.json();
                if (!response.ok) throw new Error(submissions.message || 'Failed to fetch submissions');
                if (submissions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No submissions found.</td></tr>';
                    return;
                }
                submissions.forEach(sub => {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = sub.submissionId.substring(0, 8) + '...';
                    row.insertCell(1).textContent = sub.name;
                    row.insertCell(2).textContent = sub.email;
                    row.insertCell(3).textContent = sub.status;
                    row.insertCell(4).innerHTML = `
                        <button class="btn btn-sm btn-warning me-2" onclick="handleUpdate('${sub.submissionId}')">Update</button>
                        <button class="btn btn-sm btn-danger" onclick="handleDelete('${sub.submissionId}')">Delete</button>`;
                });
            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.className = 'alert alert-danger';
                statusDiv.classList.remove('d-none');
            }
        });
        
        async function handleUpdate(id) {
            alert(`Initiating Update for ID: ${id}. You would send a PUT request to ${API_BASE_URL}/submissions/${id}`);
        }

        async function handleDelete(id) {
            if (!confirm(`Are you sure you want to delete submission ID: ${id}?`)) return;
            try {
                const response = await fetch(`${API_BASE_URL}/submissions/${id}`, { method: 'DELETE' });
                const result = await response.json();
                if (response.ok) {
                    alert(`Deletion successful: ${result.message}`);
                    document.getElementById('fetchButton').click();
                } else throw new Error(result.message || 'Deletion failed');
            } catch (error) {
                alert(`Error deleting: ${error.message}`);
            }
        }
    </script>
</body>
</html>